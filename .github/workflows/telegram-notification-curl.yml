name: Telegram Notification (Curl)

on:
  workflow_call:
    inputs:
      message:
        description: 'Mensagem para enviar no Telegram'
        required: true
        type: string
      status:
        description: 'Status do workflow (success, failure, cancelled)'
        required: true
        type: string
      workflow_name:
        description: 'Nome do workflow que executou'
        required: true
        type: string
      run_url:
        description: 'URL da execu√ß√£o do workflow'
        required: true
        type: string
      branch:
        description: 'Branch que foi executada'
        required: false
        type: string
        default: 'main'

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Send Telegram notification via curl
        run: |
          echo "üì§ Enviando notifica√ß√£o no Telegram..."
          
          # Preparar a mensagem
          MESSAGE="ü§ñ **GitHub Actions - ${{ inputs.workflow_name }}**
          
          üìã **Status:** ${{ inputs.status == 'success' && '‚úÖ Sucesso' || inputs.status == 'failure' && '‚ùå Falha' || '‚ö†Ô∏è Cancelado' }}
          
          üåø **Branch:** ${{ inputs.branch }}
          
          üìù **Detalhes:** ${{ inputs.message }}
          
          üîó **Ver execu√ß√£o:** [${{ inputs.workflow_name }}](${{ inputs.run_url }})
          
          ‚è∞ **Executado em:** $(date -u +'%d/%m/%Y %H:%M:%S') UTC"
          
          # Enviar via curl
          RESPONSE=$(curl -s -X POST \
            "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            -H "Content-Type: application/json" \
            -d "{
              \"chat_id\": \"${TELEGRAM_CHAT_ID}\",
              \"text\": \"${MESSAGE}\",
              \"parse_mode\": \"Markdown\"
            }")
          
          echo "üì• Resposta da API:"
          echo "$RESPONSE"
          
          # Verificar se foi bem-sucedido
          if echo "$RESPONSE" | grep -q '"ok":true'; then
            echo "‚úÖ Notifica√ß√£o enviada com sucesso!"
          else
            echo "‚ùå Falha ao enviar notifica√ß√£o"
            echo "üîç Verifique o token e chat_id"
            exit 1
          fi
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
