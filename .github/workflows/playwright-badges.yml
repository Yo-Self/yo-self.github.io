name: Generate Test Badges

on:
  workflow_run:
    workflows: ["Playwright Tests - Simple", "Playwright Tests - Pull Request"]
    types:
      - completed

jobs:
  generate-badges:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion != 'skipped' }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Generate Test Status Badge
      run: |
        # Criar diretório para badges
        mkdir -p badges
        
        # Determinar status baseado no resultado do workflow
        if [ "${{ github.event.workflow_run.conclusion }}" = "success" ]; then
          echo "✅ Tests Passing" > badges/test-status.txt
          echo "🟢" > badges/test-color.txt
        else
          echo "❌ Tests Failing" > badges/test-status.txt
          echo "🔴" > badges/test-color.txt
        fi
        
        # Gerar badge SVG
        cat > badges/test-status.svg << 'EOF'
        <svg xmlns="http://www.w3.org/2000/svg" width="200" height="20">
          <rect width="200" height="20" fill="#555"/>
          <rect width="120" height="20" fill="#007ec6"/>
          <text x="10" y="14" fill="white" font-family="Arial" font-size="12">Playwright Tests</text>
          <text x="130" y="14" fill="white" font-family="Arial" font-size="12">$(cat badges/test-status.txt)</text>
        </svg>
        EOF
        
        echo "Badge generated: $(cat badges/test-status.txt)"
    
    - name: Commit and push badges
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add badges/
        git diff --quiet && git diff --staged --quiet || git commit -m "Update test status badges [skip ci]"
        git push
