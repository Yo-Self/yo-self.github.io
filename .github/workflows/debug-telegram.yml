name: Debug Telegram API

on:
  workflow_dispatch:

jobs:
  debug:
    runs-on: ubuntu-latest
    steps:
      - name: Debug Telegram Configuration
        run: |
          echo "üîç DEBUG COMPLETO DA CONFIGURA√á√ÉO TELEGRAM"
          echo "=========================================="
          echo ""
          
          # Verificar secrets
          echo "üìã SECRETS CONFIGURADOS:"
          echo "   TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN != '' && '‚úÖ Configurado' || '‚ùå N√£o configurado' }}"
          echo "   TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID != '' && '‚úÖ Configurado' || '‚ùå N√£o configurado' }}"
          echo ""
          
          # Verificar valores (mascarados)
          if [ -n "${{ secrets.TELEGRAM_BOT_TOKEN }}" ]; then
            TOKEN="${{ secrets.TELEGRAM_BOT_TOKEN }}"
            echo "üîë TOKEN (mascarado):"
            echo "   Comprimento: ${#TOKEN} caracteres"
            echo "   Primeiros 15 chars: ${TOKEN:0:15}..."
            echo "   √öltimos 10 chars: ...${TOKEN: -10}"
          fi
          
          if [ -n "${{ secrets.TELEGRAM_CHAT_ID }}" ]; then
            CHAT_ID="${{ secrets.TELEGRAM_CHAT_ID }}"
            echo "üë• CHAT ID:"
            echo "   Valor: $CHAT_ID"
            echo "   Comprimento: ${#CHAT_ID} caracteres"
          fi
          
          echo ""
          echo "üîó TESTES DE CONECTIVIDADE:"
          
          # Testar se o bot existe
          echo "üì± Testando se o bot existe..."
          BOT_RESPONSE=$(curl -s "https://api.telegram.org/bot${TOKEN}/getMe")
          echo "   Resposta: $BOT_RESPONSE"
          
          if echo "$BOT_RESPONSE" | grep -q '"ok":true'; then
            echo "   ‚úÖ Bot encontrado!"
            
            # Extrair informa√ß√µes do bot
            BOT_NAME=$(echo "$BOT_RESPONSE" | grep -o '"first_name":"[^"]*"' | cut -d'"' -f4)
            BOT_USERNAME=$(echo "$BOT_RESPONSE" | grep -o '"username":"[^"]*"' | cut -d'"' -f4)
            echo "   üìù Nome: $BOT_NAME"
            echo "   üÜî Username: @$BOT_USERNAME"
            
            # Testar se pode acessar o chat
            echo "üë• Testando acesso ao chat..."
            CHAT_RESPONSE=$(curl -s "https://api.telegram.org/bot${TOKEN}/getChat?chat_id=${CHAT_ID}")
            echo "   Resposta: $CHAT_RESPONSE"
            
            if echo "$CHAT_RESPONSE" | grep -q '"ok":true'; then
              echo "   ‚úÖ Chat acess√≠vel!"
              
              # Extrair informa√ß√µes do chat
              CHAT_TITLE=$(echo "$CHAT_RESPONSE" | grep -o '"title":"[^"]*"' | cut -d'"' -f4)
              CHAT_TYPE=$(echo "$CHAT_RESPONSE" | grep -o '"type":"[^"]*"' | cut -d'"' -f4)
              echo "   üìù T√≠tulo: $CHAT_TITLE"
              echo "   üè∑Ô∏è Tipo: $CHAT_TYPE"
              
              # Testar envio de mensagem
              echo "üì§ Testando envio de mensagem..."
              SEND_RESPONSE=$(curl -s -X POST \
                "https://api.telegram.org/bot${TOKEN}/sendMessage" \
                -H "Content-Type: application/json" \
                -d "{
                  \"chat_id\": \"${CHAT_ID}\",
                  \"text\": \"üß™ Teste de debug - API funcionando!\",
                  \"parse_mode\": \"Markdown\"
                }")
              echo "   Resposta: $SEND_RESPONSE"
              
              if echo "$SEND_RESPONSE" | grep -q '"ok":true'; then
                echo "   ‚úÖ Mensagem enviada com sucesso!"
                echo ""
                echo "üéØ STATUS: TUDO FUNCIONANDO PERFEITAMENTE!"
              else
                echo "   ‚ùå Falha ao enviar mensagem"
                echo "   üîç Verifique as permiss√µes do bot no chat"
              fi
            else
              echo "   ‚ùå Chat n√£o acess√≠vel"
              echo "   üîç Verifique se o bot foi adicionado ao grupo/canal"
            fi
          else
            echo "   ‚ùå Bot n√£o encontrado"
            echo "   üîç Verifique o token do bot"
          fi
          
          echo ""
          echo "üìä RESUMO FINAL:"
          echo "   Bot v√°lido: ${{ secrets.TELEGRAM_BOT_TOKEN != '' && '‚úÖ Sim' || '‚ùå N√£o' }}"
          echo "   Chat acess√≠vel: ${{ secrets.TELEGRAM_CHAT_ID != '' && '‚úÖ Sim' || '‚ùå N√£o' }}"
          echo "   API funcionando: ${{ '‚úÖ Sim' || '‚ùå N√£o' }}"
        env:
          TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
